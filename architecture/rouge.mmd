flowchart TD
    %% --- 1. 목표 설정 단계 ---
    SettingTarget("목표 설정")
    SettingTarget           --> AreWeInDanger("도망쳐야하는 상황인가?")

    AreWeInDanger -- "Yes"   --> TargetExit("목표 = 출구")
    AreWeInDanger -- "No"    --> ShouldIUseSmokescreen("연막탄 사용 조건 충족?<br>(부상당한 아군 2명 이상 밀집)")

    ShouldIUseSmokescreen -- "Yes" --> TargetSmokescreen("목표 = 연막탄 투척 위치")
    ShouldIUseSmokescreen -- "No"  --> IsStealthed("현재 은신 상태인가?")

    IsStealthed -- "Yes"     --> TargetFlank("목표 = 드래곤의 측면/후방")
    IsStealthed -- "No"      --> DoIHaveSpellSlot("주문 슬롯(은신)이 있는가?")

    DoIHaveSpellSlot -- "No" --> TargetFlank("목표 = 드래곤의 측면/후방")
    DoIHaveSpellSlot -- "Yes"--> UseStealth("은신 사용")

    UseStealth              --> DecreaseSpellSlot("주문 슬롯 1 소모")
    DecreaseSpellSlot       --> DecreaseActionPointsForStealth("행동력 1 소모")
    DecreaseActionPointsForStealth --> TargetFlank("목표 = 드래곤의 측면/후방")
    
    TargetExit              --> MoveStart("행동 시작")
    TargetFlank             --> MoveStart("행동 시작")
    TargetSmokescreen       --> MoveStart("행동 시작")

    %% --- 2. 이동 및 행동 결정 ---
    MoveStart               --> CanIMove("이동력이 1 이상인가?")
    
    CanIMove      -- "Yes"   --> MoveToTarget("목표로 1칸 이동")
    CanIMove      -- "No"    --> PostMoveAction("이동 후 행동 결정")

    MoveToTarget            --> DecreaseMovePoint("이동력 1 소모")
    DecreaseMovePoint       --> CanIMove

    %% --- 3. 최종 행동 실행 단계 ---
    PostMoveAction          --> CanIAct("행동력이 1 이상인가?")
    CanIAct       -- "No"    --> TurnEnd("턴 종료")
    CanIAct       -- "Yes"   --> WhatIsMyGoal{현재 목표는?}

    WhatIsMyGoal -- "목표==연막탄" --> UseSmokescreen("연막탄 사용")
    WhatIsMyGoal -- "그 외 목표" --> IsDragonInRange("드래곤이 공격 범위 안에 있나?")

    UseSmokescreen          --> DecreaseSpellSlotForSmoke("주문 슬롯 1 소모")
    DecreaseSpellSlotForSmoke --> DecreaseActionPointsForSmoke("행동력 1 소모")
    DecreaseActionPointsForSmoke --> TurnEnd("턴 종료")

    IsDragonInRange -- "No"  --> TurnEnd("턴 종료")
    IsDragonInRange -- "Yes" --> IsAtFlank("현재 위치가<br>드래곤의 측/후방인가?")

    IsAtFlank -- "Yes"       --> SneakAttack("기습 공격")
    IsAtFlank -- "No"        --> Attack("일반 공격")

    SneakAttack             --> WasIStealthed("공격 시 은신 상태였는가?")
    WasIStealthed -- "Yes"   --> BreakStealth("은신 해제")
    WasIStealthed -- "No"    --> DecreaseActionPoints("행동력 1 소모")
    
    BreakStealth            --> DecreaseActionPoints("행동력 1 소모")
    Attack                  --> DecreaseActionPoints("행동력 1 소모")

    DecreaseActionPoints    --> PostMoveAction("추가 행동 결정")